<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <rewrite>
            <rules>

                <!-- Izinkan hanya index.php di public -->
                <rule name="Allow Public Index" stopProcessing="true">
                    <match url="^index\.php$" ignoreCase="true" />
                    <action type="None" />
                </rule>

                <!-- Blokir index.php di luar public -->
                <rule name="Block index.php outside Public" stopProcessing="true">
                    <match url="^(?!index\.php$).*index\.php$" ignoreCase="true" />
                    <action type="AbortRequest" />
                </rule>

                <rule name="Block Execution of Programming Files in Public Subfolders" stopProcessing="true">
                    <match url="^public/.+/.*\.(php|html|py|sh|bat|exe|cgi|pl|rb|java|cpp|c|ts|go|cs|swift|kt|dart|jsp|aspx|asp|lua|md|json|xml|sql|yaml|yml|env|ini)$" ignoreCase="true" />
                    <action type="AbortRequest" />
                </rule>

                <!-- Izinkan hanya file gambar dan dokumen di storage -->
                <rule name="Allow Only Safe Files in Storage" stopProcessing="true">
                    <match url="^storage/.*\.(jpg|jpeg|png|gif|svg|webp|pdf|doc|docx|xls|xlsx|ppt|pptx|txt|csv)$" ignoreCase="true" />
                    <action type="None" />
                </rule>

                <!-- Blokir semua file bahasa pemrograman dan file berbahaya di storage -->
                <rule name="Block Programming Files in Storage" stopProcessing="true">
                    <match url="^storage/.*\.(php|html|js|css|py|sh|bat|exe|cgi|pl|rb|java|cpp|c|ts|go|cs|swift|kt|dart|jsp|aspx|asp|lua|md|json|xml|sql|yaml|yml|env|ini)$" ignoreCase="true" />
                    <action type="AbortRequest" />
                </rule>

                <!-- Izinkan akses ke file statis di public (CSS, JS, Fonts, dll.) -->
                <rule name="Allow Static Files" stopProcessing="true">
                    <match url="^(public/).*\.(jpg|jpeg|png|gif|svg|webp|css|js|ico|woff|woff2|ttf|eot)$" ignoreCase="true" />
                    <action type="None" />
                </rule>

                <!-- Blokir semua file PHP di sensitive folders -->
                <rule name="Block PHP in Sensitive Folders" stopProcessing="true">
                    <match url="^(logs|backup|private|temp|cache|config|tests|database|bootstrap)/.*\.php$" ignoreCase="true" />
                    <action type="AbortRequest" />
                </rule>

                <!-- Redirect Trailing Slash -->
                <rule name="Redirect Trailing Slash" stopProcessing="true">
                    <match url="^(.*)/$" ignoreCase="false" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" ignoreCase="false" negate="true" />
                    </conditions>
                    <action type="Redirect" redirectType="Permanent" url="/{R:1}" />
                </rule>

                <!-- Redirect Semua Request ke index.php Jika Bukan File atau Folder -->
                <rule name="Rewrite All to index.php" stopProcessing="true">
                    <match url="^" ignoreCase="false" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" ignoreCase="false" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" ignoreCase="false" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="index.php" />
                </rule>

            </rules>
        </rewrite>

        <!-- Blokir akses langsung ke file konfigurasi -->
        <security>
            <requestFiltering>
                <fileExtensions>
                    <!-- Hapus aturan yang memblokir .php -->
                    <!-- Blokir hanya .php di storage/ bukan di public -->
                    <!-- <add fileExtension=".html" allowed="false" /> -->
                    <!-- <add fileExtension=".js" allowed="false" /> -->
                    <!-- <add fileExtension=".css" allowed="false" /> -->
                    <add fileExtension=".exe" allowed="false" />
                    <add fileExtension=".sh" allowed="false" />
                    <add fileExtension=".bat" allowed="false" />
                    <add fileExtension=".pl" allowed="false" />
                </fileExtensions>

                <!-- Hilangkan pemblokiran total pada storage -->
                <!-- <denyUrlSequences>
                    <add sequence="storage/" />
                </denyUrlSequences> -->
            </requestFiltering>
        </security>

        <handlers>
            <remove name="PHP 8.0" />
            <remove name="PHP 8.1" />
            <remove name="PHP 8.3" />
            <remove name="PHP 8.4" />
            <remove name="PHP 7.4" />
            <remove name="PHP 7.3" />
            <remove name="PHP 7.2" />
        </handlers>

        <defaultDocument>
            <files>
                <remove value=".htaccess" />
            </files>
        </defaultDocument>

        <directoryBrowse enabled="false" />

        <!-- Konfigurasi Error -->
        <!-- <httpErrors errorMode="Detailed" />
        <asp scriptErrorSentToBrowser="true" /> -->
        <!-- Konfigurasi Error -->
        <httpErrors errorMode="Custom" existingResponse="PassThrough" />
        <asp scriptErrorSentToBrowser="false" />
    </system.webServer>
</configuration>
